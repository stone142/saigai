<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½å®³æ™‚è·å“¡ãƒ»å‚·ç—…è€…ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ”¹å–„ç‰ˆï¼‰</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
        }
        .error-border {
            border-color: #ef4444 !important;
            border-width: 2px !important;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [view, setView] = useState('home');
            const [staffId, setStaffId] = useState('');
            const [patientId, setPatientId] = useState('');
            const [isComposing, setIsComposing] = useState(false);
            
            // æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆç”¨ã®çŠ¶æ…‹
            const [staffSearchTerm, setStaffSearchTerm] = useState('');
            const [staffSortBy, setStaffSortBy] = useState('updated'); // 'updated' or 'name'
            const [patientSearchTerm, setPatientSearchTerm] = useState('');
            const [patientSortBy, setPatientSortBy] = useState('triageNumber');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
            const [staffErrors, setStaffErrors] = useState({});
            const [patientErrors, setPatientErrors] = useState({});

            const [staffData, setStaffData] = useState({
                staffId: '',
                name: '',
                department: '',
                status: '',
                contactNumber: '',
                familyStatus: '',
                availableForWork: '',
                notes: '',
                timestamp: '',
                updatedAt: ''
            });

            const [patientData, setPatientData] = useState({
                triageNumber: '',
                name: '',
                patientId: '',
                gender: '',
                age: '',
                area: '',
                injury: '',
                treatment: '',
                timestamp: '',
                updatedAt: ''
            });

            // åŠè§’å¤‰æ›é–¢æ•°
            const toHalfWidth = (str) => {
                return str.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            };

            // ç›¸å¯¾æ™‚é–“è¡¨ç¤ºé–¢æ•°
            const getRelativeTime = (timestamp) => {
                if (!timestamp) return '';
                const now = new Date();
                const past = new Date(timestamp);
                const diffMs = now - past;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffMins < 1) return 'ãŸã£ãŸä»Š';
                if (diffMins < 60) return `${diffMins}åˆ†å‰`;
                if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
                return `${diffDays}æ—¥å‰`;
            };

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°
            const checkDuplicate = (type, id) => {
                const key = type === 'staff' ? `staff:${id}` : `patient:${id}`;
                return localStorage.getItem(key) !== null;
            };

            // è·å“¡ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const validateStaffData = () => {
                const errors = {};
                if (!staffData.name.trim()) errors.name = true;
                if (!staffData.department.trim()) errors.department = true;
                if (!staffData.status) errors.status = true;
                setStaffErrors(errors);
                return Object.keys(errors).length === 0;
            };

            // å‚·ç—…è€…ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const validatePatientData = () => {
                const errors = {};
                if (!patientData.name.trim()) errors.name = true;
                if (!patientData.area) errors.area = true;
                
                if (patientData.patientId) {
                    if (patientData.patientId.length !== 8) errors.patientId = true;
                    if (!/^\d{8}$/.test(patientData.patientId)) errors.patientId = true;
                }
                
                setPatientErrors(errors);
                return Object.keys(errors).length === 0;
            };

            // è·å“¡IDå…¥åŠ›å‡¦ç†
            const handleStaffInput = () => {
                const id = toHalfWidth(staffId);
                
                if (!id) {
                    alert('è·å“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (!/^\d+$/.test(id)) {
                    alert('è·å“¡IDã¯åŠè§’æ•°å­—ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const existingData = localStorage.getItem(`staff:${id}`);
                
                if (existingData) {
                    if (confirm(`è·å“¡IDã€Œ${id}ã€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\nå†…å®¹ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                        const data = JSON.parse(existingData);
                        setStaffData(data);
                        setView('staff');
                    }
                } else {
                    setStaffData({
                        staffId: id,
                        name: '',
                        department: '',
                        status: '',
                        contactNumber: '',
                        familyStatus: '',
                        availableForWork: '',
                        notes: '',
                        timestamp: '',
                        updatedAt: ''
                    });
                    setView('staff');
                }
            };

            // æ‚£è€…IDå…¥åŠ›å‡¦ç†
            const handlePatientInput = () => {
                const id = toHalfWidth(patientId);
                
                if (!id) {
                    alert('ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const existingData = localStorage.getItem(`patient:${id}`);
                
                if (existingData) {
                    if (confirm(`ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç•ªå·ã€Œ${id}ã€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\nå†…å®¹ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                        const data = JSON.parse(existingData);
                        setPatientData(data);
                        setView('patient');
                    }
                } else {
                    setPatientData({
                        triageNumber: id,
                        name: '',
                        patientId: '',
                        gender: '',
                        age: '',
                        area: '',
                        injury: '',
                        treatment: '',
                        timestamp: '',
                        updatedAt: ''
                    });
                    setView('patient');
                }
            };

            // è·å“¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            const saveStaffData = () => {
                if (!validateStaffData()) {
                    alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const now = new Date().toLocaleString('ja-JP');
                const dataToSave = {
                    ...staffData,
                    timestamp: staffData.timestamp || now,
                    updatedAt: now
                };

                localStorage.setItem(`staff:${staffData.staffId}`, JSON.stringify(dataToSave));
                alert('ç™»éŒ²ã—ã¾ã—ãŸ');
                setView('select');
                setStaffId('');
                setStaffData({
                    staffId: '',
                    name: '',
                    department: '',
                    status: '',
                    contactNumber: '',
                    familyStatus: '',
                    availableForWork: '',
                    notes: '',
                    timestamp: '',
                    updatedAt: ''
                });
                setStaffErrors({});
            };

            // å‚·ç—…è€…ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            const savePatientData = () => {
                if (!validatePatientData()) {
                    alert('å¿…é ˆé …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                // æ‚£è€…IDã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒªã‚¢ãƒ¼ã‚¸ç•ªå·ã¨ã¯åˆ¥ï¼‰
                if (patientData.patientId) {
                    const allPatients = Object.keys(localStorage)
                        .filter(key => key.startsWith('patient:'))
                        .map(key => JSON.parse(localStorage.getItem(key)));
                    
                    const duplicate = allPatients.find(p => 
                        p.patientId === patientData.patientId && 
                        p.triageNumber !== patientData.triageNumber
                    );

                    if (duplicate) {
                        if (!confirm(`æ‚£è€…IDã€Œ${patientData.patientId}ã€ã¯æ—¢ã«åˆ¥ã®ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç•ªå·ï¼ˆ${duplicate.triageNumber}ï¼‰ã§ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\nã“ã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            return;
                        }
                    }
                }

                const now = new Date().toLocaleString('ja-JP');
                const dataToSave = {
                    ...patientData,
                    timestamp: patientData.timestamp || now,
                    updatedAt: now
                };

                localStorage.setItem(`patient:${patientData.triageNumber}`, JSON.stringify(dataToSave));
                alert('ç™»éŒ²ã—ã¾ã—ãŸ');
                setView('select');
                setPatientId('');
                setPatientData({
                    triageNumber: '',
                    name: '',
                    patientId: '',
                    gender: '',
                    age: '',
                    area: '',
                    injury: '',
                    treatment: '',
                    timestamp: '',
                    updatedAt: ''
                });
                setPatientErrors({});
            };

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°
            const exportToCSV = (type) => {
                const prefix = type === 'staff' ? 'staff:' : 'patient:';
                const keys = Object.keys(localStorage).filter(key => key.startsWith(prefix));
                
                if (keys.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                const data = keys.map(key => JSON.parse(localStorage.getItem(key)));
                
                let csv = '';
                let filename = '';

                if (type === 'staff') {
                    csv = 'è·å“¡ID,æ°å,æ‰€å±,å®‰å¦çŠ¶æ³,é€£çµ¡å…ˆ,å®¶æ—ã®çŠ¶æ³,å‡ºå‹¤å¯å¦,å‚™è€ƒ,ç™»éŒ²æ—¥æ™‚,æ›´æ–°æ—¥æ™‚\n';
                    data.forEach(item => {
                        csv += `${item.staffId},"${item.name}","${item.department}","${item.status}","${item.contactNumber}","${item.familyStatus}","${item.availableForWork}","${item.notes}","${item.timestamp}","${item.updatedAt}"\n`;
                    });
                    filename = `è·å“¡ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0,10)}.csv`;
                } else {
                    csv = 'ãƒˆãƒªã‚¢ãƒ¼ã‚¸ç•ªå·,æ°å,æ‚£è€…ID,æ€§åˆ¥,å¹´é½¢,ã‚¨ãƒªã‚¢,å‚·ç—…çŠ¶æ³,å‡¦ç½®å†…å®¹,ç™»éŒ²æ—¥æ™‚,æ›´æ–°æ—¥æ™‚\n';
                    data.forEach(item => {
                        csv += `${item.triageNumber},"${item.name}","${item.patientId}","${item.gender}","${item.age}","${item.area}","${item.injury}","${item.treatment}","${item.timestamp}","${item.updatedAt}"\n`;
                    });
                    filename = `å‚·ç—…è€…ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0,10)}.csv`;
                }

                // BOMä»˜ãUTF-8ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            // ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚½ãƒ¼ãƒˆ
            const getStaffList = () => {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('staff:'));
                let list = keys.map(key => JSON.parse(localStorage.getItem(key)));

                // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
                if (staffSearchTerm) {
                    list = list.filter(item => 
                        item.name.includes(staffSearchTerm) || 
                        item.department.includes(staffSearchTerm) ||
                        item.staffId.includes(staffSearchTerm)
                    );
                }

                // ã‚½ãƒ¼ãƒˆ
                if (staffSortBy === 'updated') {
                    list.sort((a, b) => new Date(b.updatedAt || b.timestamp) - new Date(a.updatedAt || a.timestamp));
                } else if (staffSortBy === 'name') {
                    list.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                }

                return list;
            };

            const getPatientList = () => {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('patient:'));
                let list = keys.map(key => JSON.parse(localStorage.getItem(key)));

                // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
                if (patientSearchTerm) {
                    list = list.filter(item => 
                        item.name.includes(patientSearchTerm) || 
                        item.triageNumber.includes(patientSearchTerm) ||
                        item.patientId.includes(patientSearchTerm)
                    );
                }

                // ã‚½ãƒ¼ãƒˆ
                if (patientSortBy === 'triageNumber') {
                    list.sort((a, b) => a.triageNumber.localeCompare(b.triageNumber));
                } else if (patientSortBy === 'name') {
                    list.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                } else if (patientSortBy === 'updated') {
                    list.sort((a, b) => new Date(b.updatedAt || b.timestamp) - new Date(a.updatedAt || a.timestamp));
                }

                return list;
            };

            // ãƒ›ãƒ¼ãƒ ç”»é¢
            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">ğŸ¥</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">ç½å®³æ™‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                                <p className="text-gray-600">è·å“¡ãƒ»å‚·ç—…è€…æƒ…å ±ç®¡ç†</p>
                            </div>
                            
                            <div className="space-y-4">
                                <button
                                    onClick={() => setView('select')}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 shadow-lg"
                                >
                                    ğŸ“ æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹
                                </button>
                                
                                <button
                                    onClick={() => setView('headquarters')}
                                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 shadow-lg"
                                >
                                    ğŸ“Š æœ¬éƒ¨ç”»é¢ï¼ˆä¸€è¦§è¡¨ç¤ºï¼‰
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // ç™»éŒ²ç¨®åˆ¥é¸æŠç”»é¢
            if (view === 'select') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">ç™»éŒ²ç¨®åˆ¥ã‚’é¸æŠ</h2>
                            
                            <div className="space-y-4">
                                <button
                                    onClick={() => setView('staffInput')}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 shadow-lg"
                                >
                                    ğŸ‘¤ è·å“¡æƒ…å ±ã‚’ç™»éŒ²
                                </button>
                                
                                <button
                                    onClick={() => setView('patientInput')}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 shadow-lg"
                                >
                                    ğŸš‘ å‚·ç—…è€…æƒ…å ±ã‚’ç™»éŒ²
                                </button>
                                
                                <button
                                    onClick={() => setView('home')}
                                    className="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-200"
                                >
                                    â† æˆ»ã‚‹
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // è·å“¡IDå…¥åŠ›ç”»é¢
            if (view === 'staffInput') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">è·å“¡IDå…¥åŠ›</h2>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    è·å“¡IDï¼ˆåŠè§’æ•°å­—ï¼‰
                                </label>
                                <input
                                    type="text"
                                    value={staffId}
                                    onChange={(e) => setStaffId(toHalfWidth(e.target.value))}
                                    placeholder="ä¾‹: 0001"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    onCompositionStart={() => setIsComposing(true)}
                                    onCompositionEnd={() => setIsComposing(false)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && !isComposing) {
                                            handleStaffInput();
                                        }
                                    }}
                                />
                            </div>
                            
                            <div className="space-y
